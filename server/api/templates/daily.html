{% extends "base.html" %}

{% block title %}Daily Activity - {{ current_date }}{% endblock %}

{% block content %}
<div class="header">
    <h1>Daily Activity</h1>
    <div class="controls">
        <label for="date">Date:</label>
        <input type="date" id="date" value="{{ current_date }}" onchange="changeDate(this.value)">
    </div>
</div>

{% if not data %}
<div class="no-data">
    <h3>No data for this date</h3>
    <p>Select a different date or check if agents are running</p>
</div>
{% else %}
    {% for machine_data in data %}
    <div class="machine-card">
        <h3>{{ machine_data.label }}</h3>
        <div class="machine-id">{{ machine_data.machine_id }}</div>
        
        <!-- Activity Chart -->
        <div class="chart-title">User Activity (by hour)</div>
        <div class="chart-container">
            <canvas id="activity-{{ loop.index }}"></canvas>
        </div>
        
        <!-- Resources Chart -->
        {% if machine_data.has_resources %}
        <div class="chart-title">System Resources (by hour, avg during activity)</div>
        <div class="chart-container">
            <canvas id="resources-{{ loop.index }}"></canvas>
        </div>
        {% endif %}
        
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat">
                <div class="stat-value">{{ machine_data.total_keys }}</div>
                <div class="stat-label">Total Keys</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ machine_data.total_clicks }}</div>
                <div class="stat-label">Total Clicks</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ machine_data.total_scroll }}</div>
                <div class="stat-label">Total Scroll</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ machine_data.active_hours }}h</div>
                <div class="stat-label">Active Hours</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ machine_data.active_minutes }}m</div>
                <div class="stat-label">Active Minutes</div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

<script>
const chartData = {{ chart_data | tojson }};
const dataDateUTC = "{{ current_date }}";

// Конвертируем UTC часы в локальные
function convertUTCHoursToLocal(utcHours) {
    const localHours = [];
    const tzOffset = new Date().getTimezoneOffset() / -60; // в часах, например +2 для Киева зимой, +3 летом
    
    for (let utcHour = 0; utcHour < 24; utcHour++) {
        let localHour = utcHour + tzOffset;
        if (localHour >= 24) localHour -= 24;
        if (localHour < 0) localHour += 24;
        localHours.push(`${String(localHour).padStart(2, '0')}:00`);
    }
    return localHours;
}

// Переставляем данные согласно локальному времени
function reorderDataForLocalTime(data, tzOffset) {
    const shift = tzOffset;
    if (shift === 0) return data;
    
    const result = new Array(24).fill(0);
    for (let utcHour = 0; utcHour < 24; utcHour++) {
        let localHour = utcHour + shift;
        if (localHour >= 24) localHour -= 24;
        if (localHour < 0) localHour += 24;
        result[localHour] = data[utcHour];
    }
    return result;
}

const tzOffset = new Date().getTimezoneOffset() / -60;
const localHourLabels = [];
for (let h = 0; h < 24; h++) {
    localHourLabels.push(`${String(h).padStart(2, '0')}:00`);
}

// Colors for lines
const colors = {
    keys: '#3498db',
    clicks: '#2ecc71', 
    distance: '#e67e22',
    scroll: '#9b59b6',
    cpu: '#e74c3c',
    ram: '#f1c40f'
};

// Create charts for each machine
chartData.forEach((machine, index) => {
    const chartIndex = index + 1;
    
    // Переставляем данные в локальное время
    const keysLocal = reorderDataForLocalTime(machine.keys, tzOffset);
    const clicksLocal = reorderDataForLocalTime(machine.clicks, tzOffset);
    const distanceLocal = reorderDataForLocalTime(machine.distance, tzOffset);
    const scrollLocal = reorderDataForLocalTime(machine.scroll, tzOffset);
    const cpuLocal = reorderDataForLocalTime(machine.cpu, tzOffset);
    const ramLocal = reorderDataForLocalTime(machine.ram, tzOffset);
    
    // Activity Chart
    const activityCtx = document.getElementById(`activity-${chartIndex}`);
    if (activityCtx) {
        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: localHourLabels,
                datasets: [
                    {
                        label: 'Keys',
                        data: keysLocal,
                        borderColor: colors.keys,
                        backgroundColor: colors.keys + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Clicks',
                        data: clicksLocal,
                        borderColor: colors.clicks,
                        backgroundColor: colors.clicks + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Distance (÷100)',
                        data: distanceLocal.map(v => v / 100),
                        borderColor: colors.distance,
                        backgroundColor: colors.distance + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Scroll (÷10)',
                        data: scrollLocal.map(v => v / 10),
                        borderColor: colors.scroll,
                        backgroundColor: colors.scroll + '20',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#ccc' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Resources Chart
    const resourcesCtx = document.getElementById(`resources-${chartIndex}`);
    if (resourcesCtx && cpuLocal.some(v => v > 0)) {
        new Chart(resourcesCtx, {
            type: 'line',
            data: {
                labels: localHourLabels,
                datasets: [
                    {
                        label: 'CPU %',
                        data: cpuLocal,
                        borderColor: colors.cpu,
                        backgroundColor: colors.cpu + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'RAM %',
                        data: ramLocal,
                        borderColor: colors.ram,
                        backgroundColor: colors.ram + '20',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#ccc' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' },
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
});

function changeDate(date) {
    const url = new URL(window.location);
    url.searchParams.set('date', date);
    window.location = url;
}
</script>
{% endblock %}
