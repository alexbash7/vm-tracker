{% extends "base.html" %}

{% block title %}Daily Activity - {{ current_date }}{% endblock %}

{% block content %}
<div class="header">
    <h1>Daily Activity</h1>
    <div class="controls">
        <label for="interval">Interval:</label>
        <select id="interval" onchange="changeInterval(this.value)">
            {% for int_val in allowed_intervals %}
            <option value="{{ int_val }}" {% if int_val == selected_interval %}selected{% endif %}>{{ int_val }} min</option>
            {% endfor %}
        </select>
        
        <label for="date">Date:</label>
        <input type="date" id="date" value="{{ current_date }}" onchange="changeDate(this.value)">
    </div>
</div>

{% if not data %}
<div class="no-data">
    <h3>No data for this date</h3>
    <p>Select a different date or check if agents are running</p>
</div>
{% else %}
    {% for machine_data in data %}
    <div class="machine-card">
        <h3>{{ machine_data.label }}</h3>
        <div class="machine-id">{{ machine_data.machine_id }}</div>
        
        <!-- Activity Chart -->
        <div class="chart-title">User Activity (by {{ selected_interval }} min)</div>
        <div class="chart-scroll-container">
            <div class="chart-container" id="chart-wrapper-{{ loop.index }}">
                <canvas id="activity-{{ loop.index }}"></canvas>
            </div>
        </div>
        
        <!-- Resources Chart -->
        {% if machine_data.has_resources %}
        <div class="chart-title">System Resources (by {{ selected_interval }} min, avg during activity)</div>
        <div class="chart-scroll-container">
            <div class="chart-container" id="resources-wrapper-{{ loop.index }}">
                <canvas id="resources-{{ loop.index }}"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Stats -->
        <div class="stats-container">
            <div class="stats-column">
                <div class="stats-column-title">Totals</div>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_keys }}</div>
                        <div class="stat-label">Total Keys</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_clicks }}</div>
                        <div class="stat-label">Total Clicks</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_scroll }}</div>
                        <div class="stat-label">Total Scroll</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_distance }}</div>
                        <div class="stat-label">Total Distance</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.active_time_formatted }}</div>
                        <div class="stat-label">Active Time</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-column">
                <div class="stats-column-title">Average per Minute</div>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_keys_per_min }}</div>
                        <div class="stat-label">Keys/min</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_clicks_per_min }}</div>
                        <div class="stat-label">Clicks/min</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_scroll_per_min }}</div>
                        <div class="stat-label">Scroll/min</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_distance_per_min }}</div>
                        <div class="stat-label">Distance/min</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

<script>
const chartData = {{ chart_data | tojson }};
const selectedInterval = {{ selected_interval }};

// Количество интервалов
const intervalsPerDay = (24 * 60) / selectedInterval;

// Ширина графика зависит от количества точек
function getChartWidth(numPoints) {
    const minWidthPerPoint = 25;
    const minWidth = 800;
    return Math.max(minWidth, numPoints * minWidthPerPoint);
}

// Конвертируем UTC лейблы в локальные
function convertLabelsToLocal(labels) {
    const tzOffset = new Date().getTimezoneOffset() / -60;
    return labels.map(label => {
        const [hours, minutes] = label.split(':').map(Number);
        let localHour = hours + tzOffset;
        if (localHour >= 24) localHour -= 24;
        if (localHour < 0) localHour += 24;
        return `${String(localHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    });
}

// Переставляем данные согласно локальному времени
function reorderDataForLocalTime(data, tzOffset, intervalMinutes) {
    const intervalsPerHour = 60 / intervalMinutes;
    const shift = tzOffset * intervalsPerHour;
    
    if (shift === 0) return data;
    
    const result = new Array(data.length).fill(0);
    for (let i = 0; i < data.length; i++) {
        let localIndex = i + shift;
        if (localIndex >= data.length) localIndex -= data.length;
        if (localIndex < 0) localIndex += data.length;
        result[Math.floor(localIndex)] = data[i];
    }
    return result;
}

const tzOffset = new Date().getTimezoneOffset() / -60;

// Colors for lines
const colors = {
    keys: '#3498db',
    clicks: '#2ecc71', 
    distance: '#e67e22',
    scroll: '#9b59b6',
    cpu: '#e74c3c',
    ram: '#f1c40f'
};

// Create charts for each machine
chartData.forEach((machine, index) => {
    const chartIndex = index + 1;
    const numPoints = machine.labels.length;
    
    // Конвертируем в локальное время
    const localLabels = convertLabelsToLocal(machine.labels);
    const keysLocal = reorderDataForLocalTime(machine.keys, tzOffset, selectedInterval);
    const clicksLocal = reorderDataForLocalTime(machine.clicks, tzOffset, selectedInterval);
    const distanceLocal = reorderDataForLocalTime(machine.distance, tzOffset, selectedInterval);
    const scrollLocal = reorderDataForLocalTime(machine.scroll, tzOffset, selectedInterval);
    const cpuLocal = reorderDataForLocalTime(machine.cpu, tzOffset, selectedInterval);
    const ramLocal = reorderDataForLocalTime(machine.ram, tzOffset, selectedInterval);
    
    // Устанавливаем ширину контейнера
    const chartWidth = getChartWidth(numPoints);
    const activityWrapper = document.getElementById(`chart-wrapper-${chartIndex}`);
    if (activityWrapper) {
        activityWrapper.style.width = `${chartWidth}px`;
    }
    
    // Activity Chart
    const activityCtx = document.getElementById(`activity-${chartIndex}`);
    if (activityCtx) {
        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: localLabels,
                datasets: [
                    {
                        label: 'Keys',
                        data: keysLocal,
                        borderColor: colors.keys,
                        backgroundColor: colors.keys + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: selectedInterval <= 15 ? 2 : 3
                    },
                    {
                        label: 'Clicks',
                        data: clicksLocal,
                        borderColor: colors.clicks,
                        backgroundColor: colors.clicks + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: selectedInterval <= 15 ? 2 : 3
                    },
                    {
                        label: 'Distance (÷100)',
                        data: distanceLocal.map(v => v / 100),
                        borderColor: colors.distance,
                        backgroundColor: colors.distance + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: selectedInterval <= 15 ? 2 : 3
                    },
                    {
                        label: 'Scroll (÷10)',
                        data: scrollLocal.map(v => v / 10),
                        borderColor: colors.scroll,
                        backgroundColor: colors.scroll + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: selectedInterval <= 15 ? 2 : 3
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#ccc' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#333' },
                        ticks: { 
                            color: '#888',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Resources Chart
    const resourcesWrapper = document.getElementById(`resources-wrapper-${chartIndex}`);
    if (resourcesWrapper) {
        resourcesWrapper.style.width = `${chartWidth}px`;
    }
    
    const resourcesCtx = document.getElementById(`resources-${chartIndex}`);
    if (resourcesCtx && cpuLocal.some(v => v > 0)) {
        new Chart(resourcesCtx, {
            type: 'line',
            data: {
                labels: localLabels,
                datasets: [
                    {
                        label: 'CPU %',
                        data: cpuLocal,
                        borderColor: colors.cpu,
                        backgroundColor: colors.cpu + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: selectedInterval <= 15 ? 2 : 3
                    },
                    {
                        label: 'RAM %',
                        data: ramLocal,
                        borderColor: colors.ram,
                        backgroundColor: colors.ram + '20',
                        tension: 0.3,
                        fill: false,
                        pointRadius: selectedInterval <= 15 ? 2 : 3
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#ccc' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#333' },
                        ticks: { 
                            color: '#888',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' },
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
});

function changeDate(date) {
    const url = new URL(window.location);
    url.searchParams.set('date', date);
    window.location = url;
}

function changeInterval(interval) {
    const url = new URL(window.location);
    url.searchParams.set('interval', interval);
    window.location = url;
}
</script>
{% endblock %}
