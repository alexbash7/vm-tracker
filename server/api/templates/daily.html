{% extends "base.html" %}

{% block title %}Daily Activity - {{ current_date }}{% endblock %}

{% block content %}
<div class="header">
    <h1>Daily Activity</h1>
    <div class="controls">
        <label for="interval">Interval:</label>
        <select id="interval" onchange="changeInterval(this.value)">
            {% for int_val in allowed_intervals %}
            <option value="{{ int_val }}" {% if int_val == selected_interval %}selected{% endif %}>{{ int_val }} min</option>
            {% endfor %}
        </select>
        
        <label for="date">Date:</label>
        <input type="date" id="date" value="{{ current_date }}" onchange="changeDate(this.value)">
    </div>
</div>

{% if not data %}
<div class="no-data">
    <h3>No data for this date</h3>
    <p>Select a different date or check if agents are running</p>
</div>
{% else %}
    {% for machine_data in data %}
    <div class="machine-card">
        <h3>{{ machine_data.label }}</h3>
        <div class="machine-id">{{ machine_data.machine_id }}</div>
        
        <!-- Activity Chart -->
        <div class="chart-title">User Activity (by {{ selected_interval }} min)</div>
        <div class="chart-scroll-container">
            <canvas id="activity-{{ loop.index }}"></canvas>
        </div>
        
        <!-- Resources Chart -->
        {% if machine_data.has_resources %}
        <div class="chart-title">System Resources (by {{ selected_interval }} min, avg during activity)</div>
        <div class="chart-scroll-container">
            <canvas id="resources-{{ loop.index }}"></canvas>
        </div>
        {% endif %}
        
        <!-- Stats -->
        <div class="stats-container">
            <div class="stats-column">
                <div class="stats-column-title">Totals</div>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_keys }}</div>
                        <div class="stat-label">Total Keys</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_clicks }}</div>
                        <div class="stat-label">Total Clicks</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_scroll }}</div>
                        <div class="stat-label">Total Scroll</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.total_distance }}</div>
                        <div class="stat-label">Total Distance</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.active_time_formatted }}</div>
                        <div class="stat-label">Active Time</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-column">
                <div class="stats-column-title">Average per Minute</div>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_keys_per_min }}</div>
                        <div class="stat-label">Keys/min</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_clicks_per_min }}</div>
                        <div class="stat-label">Clicks/min</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_scroll_per_min }}</div>
                        <div class="stat-label">Scroll/min</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{ machine_data.avg_distance_per_min }}</div>
                        <div class="stat-label">Distance/min</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

<script>
const chartData = {{ chart_data | tojson }};
const selectedInterval = {{ selected_interval }};

// Конвертируем UTC лейблы в локальные
function convertLabelsToLocal(labels) {
    const tzOffset = new Date().getTimezoneOffset() / -60;
    return labels.map(label => {
        const [hours, minutes] = label.split(':').map(Number);
        let localHour = hours + tzOffset;
        if (localHour >= 24) localHour -= 24;
        if (localHour < 0) localHour += 24;
        return `${String(Math.floor(localHour)).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    });
}

// Переставляем данные согласно локальному времени
function reorderDataForLocalTime(data, intervalMinutes) {
    const tzOffset = new Date().getTimezoneOffset() / -60;
    const intervalsPerHour = 60 / intervalMinutes;
    const shift = Math.round(tzOffset * intervalsPerHour);
    
    if (shift === 0) return data;
    
    const result = new Array(data.length).fill(0);
    for (let utcIndex = 0; utcIndex < data.length; utcIndex++) {
        let localIndex = utcIndex + shift;
        if (localIndex >= data.length) localIndex -= data.length;
        if (localIndex < 0) localIndex += data.length;
        result[localIndex] = data[utcIndex];
    }
    return result;
}

// Генерируем локальные лейблы с 00:00 до 23:xx
function generateLocalLabels(intervalMinutes) {
    const labels = [];
    const intervalsPerDay = (24 * 60) / intervalMinutes;
    for (let i = 0; i < intervalsPerDay; i++) {
        const totalMinutes = i * intervalMinutes;
        const hour = Math.floor(totalMinutes / 60);
        const minute = totalMinutes % 60;
        labels.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
    }
    return labels;
}

const localLabels = generateLocalLabels(selectedInterval);

// Colors for lines
const colors = {
    keys: '#3498db',
    clicks: '#2ecc71', 
    distance: '#e67e22',
    scroll: '#9b59b6',
    cpu: '#e74c3c',
    ram: '#f1c40f'
};

// Create charts for each machine
chartData.forEach((machine, index) => {
    const chartIndex = index + 1;
    
    // Переставляем данные в локальное время
    const keysLocal = reorderDataForLocalTime(machine.keys, selectedInterval);
    const clicksLocal = reorderDataForLocalTime(machine.clicks, selectedInterval);
    const distanceLocal = reorderDataForLocalTime(machine.distance, selectedInterval);
    const scrollLocal = reorderDataForLocalTime(machine.scroll, selectedInterval);
    const cpuLocal = reorderDataForLocalTime(machine.cpu, selectedInterval);
    const ramLocal = reorderDataForLocalTime(machine.ram, selectedInterval);
    
    // Activity Chart
    const activityCtx = document.getElementById(`activity-${chartIndex}`);
    if (activityCtx) {
        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: localLabels,
                datasets: [
                    {
                        label: 'Keys',
                        data: keysLocal,
                        borderColor: colors.keys,
                        backgroundColor: colors.keys + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Clicks',
                        data: clicksLocal,
                        borderColor: colors.clicks,
                        backgroundColor: colors.clicks + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Distance (÷100)',
                        data: distanceLocal.map(v => v / 100),
                        borderColor: colors.distance,
                        backgroundColor: colors.distance + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Scroll (÷10)',
                        data: scrollLocal.map(v => v / 10),
                        borderColor: colors.scroll,
                        backgroundColor: colors.scroll + '20',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#ccc' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Resources Chart
    const resourcesCtx = document.getElementById(`resources-${chartIndex}`);
    if (resourcesCtx && cpuLocal.some(v => v > 0)) {
        new Chart(resourcesCtx, {
            type: 'line',
            data: {
                labels: localLabels,
                datasets: [
                    {
                        label: 'CPU %',
                        data: cpuLocal,
                        borderColor: colors.cpu,
                        backgroundColor: colors.cpu + '20',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'RAM %',
                        data: ramLocal,
                        borderColor: colors.ram,
                        backgroundColor: colors.ram + '20',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#ccc' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' },
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
});

function changeDate(date) {
    const url = new URL(window.location);
    url.searchParams.set('date', date);
    window.location = url;
}

function changeInterval(interval) {
    const url = new URL(window.location);
    url.searchParams.set('interval', interval);
    window.location = url;
}
</script>
{% endblock %}
